/*
 * This defines a custom widget which displays number of words and characters in a current text note.
 * To be activated for a given note, add label 'wordCount' to the note, you can also make it inheritable and thus activate it for the whole subtree.
 * 
 * See it in action in "Books" and its subtree.
 */
const TPL = `
<div style="padding: 10px; border-top: 1px solid var(--main-border-color); contain: none;>
    <script src="http://127.0.0.1:37840/custom/synth/synth-preset-handler.js"></script>
    <synth-preset-handler></synth-preset-handler>
</div>`;

class NeutronPresetWidget extends api.NoteContextAwareWidget 
{
    static get parentWidget() { return 'center-pane'; }

    get position() { return 100; } // higher value means position towards the bottom/right

    isEnabled() 
    {       
        return super.isEnabled()  && this.note.hasLabel('neutronPresetWidget')
            && (
            ((this.note.type === 'text' || this.note.type === 'book')) || (this.note.type === 'file' && this.note.mime === "application/json"));
    }

    doRender() 
    {
        this.$widget = $(TPL);
        this.$neutronPresetHandler = this.$widget.find('synth-preset-handler');
        return this.$widget;
    }

    async refreshWithNote(note) 
    {
        const {content} = await note.getNoteComplement();
        this.$neutronPresetHandler[0].api = api;
        console.log('API available?', typeof api !== 'undefined', typeof window.api !== 'undefined');
        console.log('API available 2?', typeof this.$neutronPresetHandler[0].api !== 'undefined');
        this.$neutronPresetHandler[0].currentNote = note;
        this.$neutronPresetHandler[0].initSynth();
    }

    async saveData()
    {
        const jsonData = {your: "data"}; // Your widget's generated data
        const jsonString = JSON.stringify(jsonData, null, 2);

        // Create a new note with the JSON content
        await api.runOnServer(async () => {
            const {noteId} = api.getActiveContextNote();
            await api.createNote({
                parentNoteId: noteId,
                title: "Widget Data Export",
                content: jsonString,
                type: "text",
                mime: "application/json"
            });
        });
    }


}

module.exports = NeutronPresetWidget;